<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Perfil</title>
  <link rel="stylesheet" href="../CSS/reset-stylesheet.css" />
  <link rel="stylesheet" href="../CSS/colors.css" />
  <link rel="stylesheet" href="../CSS/navigation.css" />
  <link rel="stylesheet" href="../CSS/edit-profile.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

<header id="navigation">
  <nav id="session-navbar">
    <div id="us">
      <img id="logo" src="../mockups/logo.png" alt="logo" />
      <div id="brand-name">Itineraries</div>
    </div>
    <div id="links">
      <button class="nav-button" onclick="location.href='home-page.html'">Home</button>
      <button class="nav-button" onclick="location.href='user-logout.html'">Cerrar sesión</button>
    </div>
    <!-- Usuario y foto -->
    <div id="user-info" style="display: flex; align-items: center; gap: 10px;">
      <img id="user-photo" src="" alt="Foto de perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
      <span id="user-name" style="font-weight: 600; font-size: 1rem; color: #000;"></span>
    </div>
  </nav>
</header>

<main>
  <div class="edit-profile-container">
    <h2>Editar Perfil</h2>
    <form id="edit-profile-form">
      <div class="form-group">
        <label for="profile-picture">Foto de perfil</label>
        <input type="file" id="profile-picture" accept="image/*">
        <img id="current-photo" src="" alt="Foto actual" />
      </div>

      <div class="form-group">
        <label for="display-name">Nombre</label>
        <input type="text" id="display-name" placeholder="Tu nombre">
      </div>

      <div class="form-group">
        <label for="email">Correo electrónico</label>
        <input type="email" id="email" placeholder="Tu correo">
      </div>

      <div class="form-group">
        <label for="password">Nueva contraseña</label>
        <input type="password" id="password" placeholder="Nueva contraseña">
      </div>

      <button type="submit" id="save-button">Guardar cambios</button>
    </form>
  </div>
</main>

<!-- ✅ JS de perfil -->
<script type="module">
  import { getAuth, onAuthStateChanged, updateEmail, updatePassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

  const auth = getAuth();
  const storage = getStorage();

  const userNameEl = document.getElementById("user-name");
  const userPhotoEl = document.getElementById("user-photo");
  const currentPhotoEl = document.getElementById("current-photo");
  const nameInput = document.getElementById("display-name");
  const emailInput = document.getElementById("email");

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userNameEl.textContent = user.displayName || "Usuario";
      userPhotoEl.src = user.photoURL || "https://via.placeholder.com/40";
      currentPhotoEl.src = user.photoURL || "https://via.placeholder.com/80";
      nameInput.value = user.displayName || "";
      emailInput.value = user.email || "";
    }
  });

  document.getElementById("edit-profile-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const user = auth.currentUser;
    if (!user) return;

    const newName = nameInput.value.trim();
    const newEmail = emailInput.value.trim();
    const newPassword = document.getElementById("password").value;
    const file = document.getElementById("profile-picture").files[0];

    try {
      let photoURL = user.photoURL;

      if (file) {
        const storageRef = ref(storage, `users/${user.uid}/profile.jpg`);
        await uploadBytes(storageRef, file);
        photoURL = await getDownloadURL(storageRef);
      }

      await updateProfile(user, {
        displayName: newName,
        photoURL: photoURL
      });

      if (newEmail !== user.email) {
        await updateEmail(user, newEmail);
      }

      if (newPassword) {
        await updatePassword(user, newPassword);
      }

      alert("Perfil actualizado correctamente");
      location.reload();
    } catch (error) {
      console.error("Error al actualizar perfil:", error);
      alert(`Error: ${error.message}`);
    }
  });
</script>

</body>
</html>
